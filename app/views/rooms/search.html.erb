<% content_for :title, "Rooms" %>
<!-- Search Section -->
<div class="container my-5" data-controller="room">
  <div class="bg-light p-4 rounded shadow-sm">
    <%= form_with url: search_rooms_path, method: :get, local: true, class: "d-flex align-items-center justify-content-between" do |form| %>
      <div class="form-group mb-0 mr-2">
        <%= form.label :check_in_date, "Check-in Date", class: "sr-only" %>
        <%= form.date_field :check_in_date, value: @check_in_date, class: "form-control", placeholder: "Check-in Date", min: Date.today %>
      </div>
      <div class="form-group mb-0 mr-2">
        <%= form.label :check_out_date, "Check-out Date", class: "sr-only" %>
        <%= form.date_field :check_out_date, value: @check_out_date, class: "form-control", placeholder: "Check-out Date", min: Date.today %>
      </div>
      <div class="form-group mb-0 mr-2">
        <%= form.label :guest_amount, "Number of Guests", class: "sr-only" %>
        <%= form.number_field :guest_amount, value: @guest_amount, class: "form-control", min: 1, placeholder: "Guests" %>
      </div>
      <div class="form-group mb-0 mr-2">
        <%= form.label :sort_by, "Sort by", class: "sr-only" %>
        <%= form.select :sort_by, options_for_select([["Price (Low to High)", "price_asc"], ["Price (High to Low)", "price_desc"], ["Capacity (Low to High)", "capacity_asc"], ["Capacity (High to Low)", "capacity_desc"]], selected: params[:sort_by]), class: "form-control" %>
      </div>
      <div class="form-group mb-0">
        <%= form.submit "Search", class: "btn btn-primary" %>
      </div>
    <% end %>
  </div>
</div>
<div class="container mb-5">
  <div class="row">
    <!-- Filters Section -->
    <div class="col-md-3">
      <h3 class="mb-4">Filters</h3>
      <div class="bg-light p-3 rounded shadow-sm">
        <%= form_with url: search_rooms_path, method: :get, local: true do |form| %>
          <div class="form-group">
            <%= form.label :price_range, "Price Range:", class: "form-label" %>
            <span id="price_range_value">$<%= params[:price_range] || 0 %></span>
            <%= form.range_field :price_range, value: params[:price_range] || @max_price, min: 0, max: @max_price, step: 1, class: "form-range", id: "price_range", oninput: "updateRangeBackground()" %>
          </div>
          <div class="mt-4">
            <h5>Services</h5>
            <% @services.each do |service| %>
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="services[]" value="<%= service.id %>" id="service_<%= service.id %>" <%= 'checked' if params[:services]&.include?(service.id.to_s) %>>
                <label class="form-check-label" for="service_<%= service.id %>"><%= service.name %></label>
              </div>
            <% end %>
          </div>
          <div class="mt-3">
            <%= form.submit "Apply Filters", class: "btn btn-primary w-100" %>
          </div>
        <% end %>
      </div>
    </div>
    <!-- Rooms List Section -->
    <div class="col-md-9">
      <% if @no_rooms_found %>
        <div class="alert alert-danger" role="alert">
          No rooms available that can accommodate <%= @guest_amount %> guests during your selected dates.
        </div>
      <% else %>
        <div id="rooms">
          <% @rooms.each do |room| %>
            <div class="row mb-4 bg-light rounded shadow-sm border position-relative" style="border-color: #f8cdd6; border-width: 2px;">
              <div class="col-md-4 p-0">
                <% if room.image.attached? %>
                  <%= image_tag room.image.variant(resize_to_fill: [400, 300]).processed, class: "img-fluid h-100 w-100 rounded-start", alt: room.name %>
                <% else %>
                  <div class="d-flex justify-content-center align-items-center bg-secondary text-white" style="width: 100%; height: 100%; background-color: #f8cdd6;">
                    <p>No image available</p>
                  </div>
                <% end %>
              </div>
              <div class="col-md-8 p-3 d-flex flex-column justify-content-between">
                <div class="d-flex justify-content-between">
                  <h4 class="mb-2"><%= room.name %></h4>
                  <p><strong>Price:</strong> $<%= room.price %></p>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <p><strong>Capacity:</strong> <%= room.capacity %> guests</p>
                  </div>
                  <div class="col-md-6">
                    <p><strong>Beds:</strong></p>
                    <ul class="list-inline">
                      <% room.beds.each do |bed| %>
                        <li class="list-inline-item badge bg-info text-dark"><%= bed.name %> (<%= bed.capacity %>)</li>
                      <% end %>
                    </ul>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-12">
                    <p><strong>Services:</strong></p>
                    <ul class="list-inline">
                      <% room.services.each do |service| %>
                        <li class="list-inline-item badge bg-secondary"><%= service.name %></li>
                      <% end %>
                    </ul>
                  </div>
                </div>
                <div class="d-flex justify-content-end align-items-center mt-3">
                  <% if room_available?(room, @check_in_date, @check_out_date) && room.capacity >= @guest_amount.to_i %>
                    <%= link_to "Reserve Room", new_reservation_path(room_id: room.id, check_in_date: @check_in_date, check_out_date: @check_out_date), class: "btn btn-success" %>
                  <% else %>
                    <button class="btn btn-secondary btn-sm w-25" disabled>Not Available</button>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>
</div>